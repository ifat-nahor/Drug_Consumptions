import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from scipy import stats
import os

def run_universal_anova(df, group_column, target_columns=None):
    """
    מבצע מבחן ANOVA ויוצר ויזואליזציה לכל משתנה שנבחר מול עמודת קבוצה.
    
    פרמטרים:
    df: ה-DataFrame לניתוח.
    group_column: שם העמודה לפיה מחלקים לקבוצות (למשל רמת צריכת סם).
    target_columns: רשימת עמודות נומריות לבדיקה. אם None, הקוד יזהה את כל המשתנים הנומריים.
    """
    
    # 1. זיהוי אוטומטי של עמודות נומריות אם לא סופקו
    if target_columns is None:
        target_columns = df.select_dtypes(include=['number']).columns.tolist()
        # הסרת עמודת הקבוצה עצמה מרשימת הניתוח אם היא נומרית
        if group_column in target_columns:
            target_columns.remove(group_column)

    print(f"\n" + "="*60)
    print(f"UNIVERSAL ANOVA SUMMARY: Grouping by '{group_column}'")
    print("="*60)

    results = []

    # 2. הרצת המבחן לכל משתנה
    for col in target_columns:
        # ניקוי ערכים חסרים רק לעמודות הרלוונטיות
        clean_data = df[[group_column, col]].dropna()
        
        # יצירת רשימת קבוצות למבחן ANOVA
        unique_groups = sorted(clean_data[group_column].unique())
        groups = [clean_data[clean_data[group_column] == g][col] for g in unique_groups]
        
        # וידוא שיש מספיק קבוצות ונתונים למבחן
        if len(groups) > 1 and all(len(g) > 1 for g in groups):
            f_stat, p_val = stats.f_oneway(*groups)
            sig_level = "Significant" if p_val < 0.05 else "Not Significant"
            
            results.append({
                'Variable': col,
                'F-Statistic': f_stat,
                'p-value': p_val,
                'Status': sig_level
            })
            
            print(f"Variable: {col:15} | p-value: {p_val:.4e} | {sig_level}")

            # 3. ויזואליזציה לכל משתנה (Boxplot)
            plt.figure(figsize=(10, 6))
            sns.boxplot(x=group_column, y=col, data=clean_data, palette='viridis')
            plt.title(f'ANOVA: {col} by {group_column}\np-value: {p_val:.4e}', fontsize=14)
            plt.grid(axis='y', linestyle='--', alpha=0.7)
            
            # שמירת הגרף באופן אוטומטי
            plt.tight_layout()
            plt.savefig(f'anova_{group_column}_{col}.png')
            plt.close() # סגירה כדי לא להעמיס על הזיכרון
        else:
            print(f"Variable: {col:15} | Skipped (not enough data/groups)")

    # 4. יצירת טבלת סיכום סופית
    summary_df = pd.DataFrame(results)
    return summary_df
#שימוש בדאטה שלנו 
 res = run_universal_anova(df_cleaned, group_column='Coke')
#עם תכונות של אימפולסיביות ורגישות ל
# traits = ['BIS11', 'ImpSS']
# res = run_universal_anova(df_cleaned, group_column='Cannabis', target_columns=traits)