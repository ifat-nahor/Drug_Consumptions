import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from scipy import stats
import os

"""
התכונות: 
 Nscore (נוירוטיות)

Escore (מוחצנות)

Oscore (פתיחות לחוויות)

Ascore (נעימות)

Cscore (מצפוניות)
    """

# --- ניתוח ANOVA ייעודי ל-5 תכונות האופי הגדולות (Big Five) ---
print("\n" + "="*80)
print("BIG FIVE PERSONALITY TRAITS ANALYSIS")
print("="*80)

# הגדרת 5 התכונות הגדולות כפי שהן מופיעות בדאטה-סט
big_five_traits = ['Nscore', 'Escore', 'Oscore', 'Ascore', 'Cscore']

# רשימה לאחסון תוצאות ה-p-value
big_five_results = []

# מעבר על כל הסמים וביצוע ANOVA מול כל אחת מ-5 התכונות
for drug in drug_columns:
    result_row = {'Drug': drug}
    for trait in big_five_traits:
        if trait in df_cleaned.columns:
            # חלוקה לקבוצות לפי רמת הצריכה (CL0-CL6)
            unique_levels = sorted(df_cleaned[drug].unique())
            groups = [df_cleaned[df_cleaned[drug] == lvl][trait].dropna() for lvl in unique_levels]
            
            # ביצוע המבחן הסטטיסטי
            if len(groups) > 1 and all(len(g) > 1 for g in groups):
                f_stat, p_val = stats.f_oneway(*groups)
                result_row[trait] = p_val
            else:
                result_row[trait] = np.nan
                
    big_five_results.append(result_row)

# יצירת טבלת סיכום
big_five_df = pd.DataFrame(big_five_results).set_index('Drug')

# --- יצירת גרף Heatmap ל-5 התכונות בלבד ---
plt.figure(figsize=(10, 10))

# שימוש במינוס לוג 10 כדי להבליט מובהקות (צבעים כהים יותר = מובהקות גבוהה יותר)
significance_matrix = -np.log10(big_five_df.astype(float))

sns.heatmap(significance_matrix, 
            annot=big_five_df, # הצגת ה-p-value המדויק בתוך התאים
            cmap='YlOrRd', 
            fmt=".4f", 
            cbar_kws={'label': 'Significance (-log10 p-value)'})

plt.title('The Big Five vs. Drug Consumption: ANOVA Significance Map\n(Numbers = p-value | Higher color intensity = More Significant)', fontsize=15)
plt.ylabel('Drug Type', fontsize=12)
plt.xlabel('Big Five Personality Traits', fontsize=12)
plt.tight_layout()

# שמירת הגרף בנפרד
big_five_plot_path = os.path.join(current_dir, 'big_five_significance_heatmap.png')
plt.savefig(big_five_plot_path)

print(f"\n✓ Big Five analysis completed.")
print(f"✓ Dedicated heatmap saved as: {big_five_plot_path}")