import pandas as pd
import os
import matplotlib.pyplot as plt
import seaborn as sns

# 1. ייבוא הפונקציות מהקובץ שבו שמרת את קוד הניתוח
# נניח ששמרת את הקוד ששלחת לי קודם בשם 'data_analysis_functions.py'
from data_analysis_functions import (
    analyze_personality_profile,
    compare_prediction_models,
    compare_correlations_fisher_z,
    compare_drug_families_analysis
)

# 2. טעינת הנתונים המעובדים
current_dir = os.path.dirname(os.path.abspath(__file__))
processed_data_path = os.path.join(current_dir, 'data', 'processed', 'Drug_Consumption_Cleaned.csv')

if not os.path.exists(processed_data_path):
    print(f"Error: Could not find processed data at {processed_data_path}")
    exit()

df = pd.read_csv(processed_data_path)

# 3. התאמת שמות עמודות (קריטי להרצה)
# הקוד שלך מחפש 'Impulsive' ו-'SS', אז נשנה את השמות מהדאטה המקורי
name_map = {
    'BIS11': 'Impulsive',
    'ImpSS': 'SS'
}
df = df.rename(columns=name_map)

# הגדרת רשימת תכונות האישיות לניתוח
personality_traits = ['Impulsive', 'SS'] 
# ניתן להוסיף כאן עוד עמודות אם קיימות (כמו Neuroticism, Extraversion וכו')

# 4. הרצת הניתוחים
print("Starting Comprehensive Neuro-Data Analysis...")

# חלק א': ANOVA
anova_results = analyze_personality_profile(df, personality_traits)

# חלק ב': מודל חיזוי (ML) ויצירת גרף חשיבות מאפיינים
feature_importances = compare_prediction_models(df, personality_traits)

# חלק ג': מבחן Fisher Z (השוואת מתאמים)
compare_correlations_fisher_z(df)

# חלק ד': השוואה בין משפחות סמים ויצירת הגרף המסכם
family_results = compare_drug_families_analysis(df)

# 5. יצירת הגרף המשולב (ההמחשה הברורה ביותר)
def create_final_summary_plot(df, family_results):
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(16, 7))
    sns.set_style("white")

    # צד שמאל: קווי רגרסיה להשוואה בין משתמשים ללא-משתמשים
    sns.regplot(x='Impulsive', y='SS', data=df[df['Usage_Group'] == 'Non-User'], 
                scatter_kws={'alpha':0.3}, label='Non-User', ax=ax1, color='blue')
    sns.regplot(x='Impulsive', y='SS', data=df[df['Usage_Group'] == 'Regular'], 
                scatter_kws={'alpha':0.3}, label='Regular User', ax=ax1, color='red')
    ax1.set_title('Correlation: Impulsivity vs Sensation Seeking', fontsize=14, fontweight='bold')
    ax1.legend()

    # צד ימין: השוואת מתאמים לפי משפחות סמים (מבוסס על חלק ד')
    if not family_results.empty:
        sns.barplot(x='Family', y='Correlation', data=family_results, palette='magma', ax=ax2)
        ax2.set_title('Correlation Strength by Drug Family', fontsize=14, fontweight='bold')
        ax2.set_ylim(0, 1)
        for i, v in enumerate(family_results['Correlation']):
            ax2.text(i, v + 0.02, f"r={v:.2f}", ha='center', fontweight='bold')

    plt.tight_layout()
    plt.savefig('comprehensive_analysis_summary.png')
    print("\n✓ Final summary graph saved as 'comprehensive_analysis_summary.png'")
    plt.show()

create_final_summary_plot(df, family_results)